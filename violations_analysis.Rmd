---
title: "violation analysis"
author: "Restaurant group"
date: "2024-12-02"
output: 
  html_document:
    code_folding: hide
    always_allow_html: true
    toc: true
    toc_float: true
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE, 
                      message = FALSE, 
                     fig.path = "violation_files/",
  fig.format = "png")
```

## Analysis related to violation of Manhattan Restaurants
```{r}
library(tidyverse)
library(plotly)
library(ggplot2)
library(knitr)
library(readr)
library(dplyr)
library(tidyr)
library(scales)
```

• N = Not Yet Graded• A = Grade A• B = Grade B• C = Grade C• Z = Grade Pending• P= Grade Pending issued on re-opening following an initial inspection that resulted in a closure

Indicator of critical violation; "• Critical • Not Critical • Not Applicable"; Critical violations are those most likely to contribute to food-borne illness
```{r}
# The same data cleaning process in demographics part, also only consider data with valid violation_description and critical_flag, and grade A, B, C.

manhattan_data = read_csv("Manhattan_Restaurant_Inspection_Results.csv", na = c("NA", "", "."))
str (manhattan_data)

cleaned_data = manhattan_data %>%
  janitor::clean_names() %>%  
  filter(
    !is.na(dba),                         
    !is.na(cuisine_description),       
    !is.na(grade),                       
    !is.na(score),                       
    !is.na(zipcode),
    !is.na(violation_description),
    !is.na(critical_flag),
    grade %in% c("A", "B", "C")
  ) %>% mutate(region = case_when(
    zipcode >= 10000 & zipcode <= 10025 ~ "Downtown",
    zipcode >= 10026 & zipcode <= 10040 ~ "Midtown",
    zipcode >= 10041 & zipcode <= 10282 ~ "Uptown",
    TRUE ~ "Other" # For ZIP codes like 11371, 12345, etc.
  ))
```

4. Effect of violations on Grade (A,B,C…) Effect of Critical Violations on Grades
Analysis: Examine how critical violations affect the overall grade a restaurant receives. This can help show if critical violations are strongly correlated with lower grades.
Visualization: Grouped bar chart showing average scores and grades for restaurants with and without critical violations (based on CRITICAL FLAG). 

```{r}
# Analyze the effect of violation_description on grade
# Group by critical flag and grade to calculate counts
violation_grade_summary <- cleaned_data %>%
  group_by(critical_flag, grade) %>%
  summarize(count = n(), .groups = "drop")

# Calculate average scores by CRITICAL_FLAG and grade
average_score <- cleaned_data %>%
  group_by(critical_flag, grade) %>%
  summarize(avg_score = mean(score), .groups = "drop")


# Create an EDA using plotly
violation_grade = violation_grade_summary %>% 
  plot_ly(
    x = ~grade, 
    y = ~count,
    type = 'bar',
    color = ~critical_flag,
    colors = "viridis") %>% 
  layout(
    title = "Effect of Violation Type on Restaurant Grade",
    xaxis = list(title = "Grade"),   
    yaxis = list(title = "Restaurant Number") 
  )

violation_score = average_score %>% 
  plot_ly(
    x = ~grade, 
    y = ~avg_score,
    type = 'bar',
    color = ~critical_flag,
    colors = "viridis") %>% 
  layout(
    title = "Effect of Violation Type on Restaurant Score",
    xaxis = list(title = "Grade"),   
    yaxis = list(title = "Restaurant Average Score") 
  )
```

Chi-Square Test between critical_flag and grade:
conclusion: p-value<0.05, reject null, they are significant related.
```{r}
contingency_table <- table(cleaned_data$critical_flag, cleaned_data$grade)

chi_test <- chisq.test(contingency_table)

print(chi_test)


```

6. Restaurant Type vs. Violation Frequency (Spearman):
Explore whether certain restaurant types are associated with a higher frequency of violations. find which restaurant type has largest precent of critical violation.
```{r}
# Group by cuisine_description and calculate total and critical counts
violation_cuisine <- cleaned_data %>%
  mutate(critical_flag = ifelse(critical_flag == "Critical", 1, 0)) %>%
  group_by(cuisine_description) %>%
  summarize(total_violations = n(),
            critical_violations = sum(critical_flag, na.rm = TRUE),
            critical_percent = (critical_violations / total_violations),
            critical_percentage = percent(critical_percent, accuracy = 0.01)
            ) %>%
  arrange(desc(critical_percentage))  %>% # Sort by percentage of critical violations 
  head(10) # View top 10 restaurant types with the highest percentage of critical violations

plot_ly(
  type = 'table',
  header = list(
    values = c("Cuisine Description", "Critical Percentage"),
    align = c("center", "center"),
    font = list(size = 14, color = "white"),
    fill = list(color = "purple")
  ),
  cells = list(
    values = rbind(violation_cuisine$cuisine_description, violation_cuisine$critical_percentage),
    align = c("center", "center"),
    font = list(size = 12),
    fill = list(color = c("white", "white"))
  )
)
```
what type of violations are most comment in Chinese/Japanese cuisine:
```{r}
chinese_japanese <- cleaned_data %>%
  filter(cuisine_description == "Chinese/Japanese") %>% # 42 rows in total
  group_by(violation_description) %>%
  summarize(num_violation = n(),
            violation_percent = num_violation / 42,  
            violation_percentage = percent(violation_percent, accuracy = 0.01)) %>%
  arrange(desc(violation_percent))


```
what type of violations are most comment in critical violation:
```{r}
violation_critical <- cleaned_data %>%
  filter(critical_flag == "Critical") %>% # 19,953 rows in total
  group_by(violation_description) %>%
  summarize(num_violation = n(),
            violation_percent = num_violation / 19953) %>%
  mutate(
    if violation_percent < 0.003, then violation = "Other"),
if else violation = violation_description)
```








